import { openai } from '@ai-sdk/openai';
import { streamText } from 'ai';

import { getServerSession } from '#auth';
import { insightReportRequestSchema } from '@budget-habits/schemas';
import { assertRateLimit } from '@budget-habits/server-utils';
import { assertSchema } from '@budget-habits/validation';

export default defineEventHandler(async (event) => {
  const session = await getServerSession(event);
  const userId = (session?.user as any)?.id;
  if (!userId) throw createError({ statusCode: 401, statusMessage: 'Unauthorized' });

  const body = await readBody(event);
  const payload = assertSchema(insightReportRequestSchema, body);
  assertRateLimit(userId);

  const result = streamText({
    model: openai('gpt-4o-mini'),
    system: `–í—ã –æ–ø—ã—Ç–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫. –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á—ë—Ç—ã –Ω–∞ ${payload.locale === 'ru' ? '—Ä—É—Å—Å–∫–æ–º' : '–∞–Ω–≥–ª–∏–π—Å–∫–æ–º'} —è–∑—ã–∫–µ –≤ —Ç–æ–Ω–µ: ${payload.tone}.

–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –ó–∞–≥–æ–ª–æ–≤–∫–∏: ## –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤, ### –¥–ª—è –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- –°–ø–∏—Å–∫–∏: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ - –¥–ª—è –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∫–æ–º
- –í—ã–¥–µ–ª–µ–Ω–∏–µ: **–∂–∏—Ä–Ω—ã–π** –¥–ª—è –≤–∞–∂–Ω—ã—Ö —Ü–∏—Ñ—Ä –∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
- –ü–∞—Ä–∞–≥—Ä–∞—Ñ—ã: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Ä–∞–∑–¥–µ–ª—è–π—Ç–µ –±–ª–æ–∫–∏ —Ç–µ–∫—Å—Ç–∞ –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏
- –¢–∞–±–ª–∏—Ü—ã: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π markdown —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —Å | –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏

–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

## –ó–∞–≥–æ–ª–æ–≤–æ–∫

–¢–µ–∫—Å—Ç –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞.

- –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ 1
- –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ 2

–°–ª–µ–¥—É—é—â–∏–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ.`,
    messages: [
      {
        role: 'user',
        content: `–°–æ–∑–¥–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥: **${payload.period}**

–í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${payload.transactions.length}

–î–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
${JSON.stringify(payload.transactions, null, 2)}

–°–æ–∑–¥–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ markdown —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏:

## üìã –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

- –í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –î–æ—Ö–æ–¥—ã
- –†–∞—Å—Ö–æ–¥—ã
- –ß–∏—Å—Ç—ã–π –¥–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫
- –°—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥ –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é

## üí∞ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤

### –î–æ—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

(–ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç—å —Å —Å—É–º–º–∞–º–∏)

### –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

(–ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç—å —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏)

## üìä –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

–°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏.

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–î–∞–π—Ç–µ 3-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –±—é–¥–∂–µ—Ç–∞.

–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏, —Å–ø–∏—Å–∫–∞–º–∏ –∏ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞–º–∏!`,
      },
    ],
  });

  return result.toTextStreamResponse();
});
